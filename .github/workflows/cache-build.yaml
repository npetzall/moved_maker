name: Cache Build

on:
  push:
    branches:
      - main

concurrency:
  group: cache-build
  cancel-in-progress: false

jobs:
  build-cache:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          # Normal checkout with fetch-depth: 1 to optimize checkout time and bandwidth
          # while ensuring compatibility with rust-cache action (which requires a normal checkout)
          fetch-depth: 1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt llvm-tools-preview

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: false

      - name: Install security tools
        run: cargo install cargo-deny cargo-audit cargo-auditable

      - name: Install cargo-geiger
        run: cargo install --locked cargo-geiger

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      # Note: Pre-commit is NOT installed here because:
      # 1. rust-cache doesn't cache Python packages (pre-commit is a Python tool)
      # 2. The pre-commit job installs it fresh each run anyway
      # 3. Installing it here provides no benefit to other workflows

      - name: Fetch dependencies
        run: cargo fetch
