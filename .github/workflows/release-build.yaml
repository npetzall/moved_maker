name: Release Build

# This workflow is triggered via workflow_run when cache-build completes (success or failure).
# It checks if the commit has a version tag (v[MAJOR].[MINOR].[PATCH]) and only runs release jobs if a tag is found.
# When release-version workflow skips commit/tag creation (version unchanged), cache-build still runs
# but release-build correctly skips all jobs (expected behavior).
# Direct tag pushes no longer trigger this workflow - all releases must go through main branch workflow coordination.

on:
  workflow_run:
    workflows: ["Cache Build"]
    types: [completed]
    branches: [main]

jobs:
  check-tag:
    runs-on: ubuntu-latest
    outputs:
      has_tag: ${{ steps.check.outputs.has_tag }}
      tag_name: ${{ steps.check.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0  # Full history needed for tags

      # Tag detection: Check if commit has a version tag (v[MAJOR].[MINOR].[PATCH] format).
      # Errors break the build - use set -e to ensure failures are caught.
      # If multiple tags exist, only the first matching tag is used (head -n 1).
      - name: Check for version tag
        id: check
        run: |
          set -e
          git fetch --tags --force
          TAG_NAME=$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1 || true)
          if [ -n "$TAG_NAME" ]; then
            echo "has_tag=true" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "Found tag: $TAG_NAME"
          else
            echo "has_tag=false" >> $GITHUB_OUTPUT
            echo "tag_name=" >> $GITHUB_OUTPUT
            echo "No version tag found for this commit"
          fi

  security:
    needs: check-tag
    if: needs.check-tag.outputs.has_tag == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"

      - name: Install security tools
        run: cargo install cargo-deny cargo-audit cargo-auditable

      - name: Install cargo-geiger
        run: cargo install --locked cargo-geiger

      - name: Run cargo-deny checks (blocking)
        run: cargo deny check --config .config/deny.toml

      - name: Run cargo-audit checks (blocking)
        run: cargo audit --deny warnings

      # Note: cargo-geiger is not blocking - exit code 1 means unsafe code was found (informational)
      # See bugs/01_Quality/done/WORKFLOWS_GEIGER_BLOCKING.md for details
      - name: Run cargo-geiger scan
        run: cargo geiger --output-format Json > geiger-report.json || [ $? -eq 1 ]

      - name: Upload geiger report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: geiger-report
          path: geiger-report.json
          if-no-files-found: warn

  coverage:
    needs: [check-tag, security]
    if: needs.check-tag.outputs.has_tag == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: 1.90.0
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate coverage
        run: cargo llvm-cov nextest --all-features

      - name: Check jq availability
        run: |
          if ! command -v jq &> /dev/null; then
            echo "::error::jq is not installed. Required for coverage threshold checking."
            exit 1
          fi
          echo "✅ jq is available: $(jq --version)"

      - name: Check coverage thresholds
        run: |
          # Generate JSON report from collected coverage data
          cargo llvm-cov report --json > coverage.json

          # Extract percentages and check thresholds using jq script
          jq -r -e -f .config/coverage-threshold-check.jq coverage.json || exit 1

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5

      - name: Generate coverage summary
        if: always()
        run: |
          # Generate markdown coverage summary for workflow run summary
          # Summary includes overall coverage, Mermaid chart, and file breakdown
          cd .github/scripts/coverage-summary
          uv sync --extra dev
          uv run python -m coverage_summary \
            --json-path ../../../coverage.json || true

  build-and-release:
    needs: [check-tag, security, coverage]
    if: needs.check-tag.outputs.has_tag == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: moved_maker-linux-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: moved_maker-macos-aarch64
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: 1.90.0
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Run tests
        run: cargo nextest run

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5

      - name: Generate test summary
        if: always()
        run: |
          cd .github/scripts/test-summary
          uv sync --extra dev
          uv run python -m test_summary \
            --xml-path ../../../target/nextest/**/test-results.xml \
            --artifact-name test-results-${{ matrix.os }}-${{ matrix.target }}

      - name: Rename test results to avoid conflicts
        run: |
          TEST_RESULTS=$(find target/nextest -name "test-results.xml" | head -n 1)
          if [ -n "$TEST_RESULTS" ]; then
            mv "$TEST_RESULTS" target/nextest/${{ matrix.artifact_name }}-test.xml
          fi
        if: always()

      - name: Upload test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.target }}
          path: target/nextest/${{ matrix.artifact_name }}-test.xml
          if-no-files-found: warn

      - name: Install cargo-auditable
        run: cargo install cargo-auditable

      - name: Build release binary with embedded dependency info
        run: cargo auditable build --release --target ${{ matrix.target }}

      - name: Rename binary for platform-specific release
        run: |
          mv target/${{ matrix.target }}/release/moved_maker \
             target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Install cargo-audit for binary auditing
        run: cargo install cargo-audit

      - name: Audit release binary
        run: cargo audit bin target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      # Stripping handled by Cargo.toml [profile.release] strip = "debuginfo"

      - name: Create checksum
        run: |
          cd .github/scripts/create-checksum
          uv run python -m create_checksum \
            --file ../../target/${{ matrix.target }}/release/${{ matrix.artifact_name }} \
            --algo sha256 \
            --output ../../target/${{ matrix.target }}/release/${{ matrix.artifact_name }}.sha256

      - name: Upload artifact (binary and checksum)
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
            target/${{ matrix.target }}/release/${{ matrix.artifact_name }}.sha256
          retention-days: 1

  release:
    needs: [check-tag, build-and-release]
    if: needs.check-tag.outputs.has_tag == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0  # Full history needed for git rev-list path filtering

      - name: Install uv
        uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a  # v5

      - name: Generate release notes
        id: release_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ needs.check-tag.outputs.tag_name }}
        run: |
          cd .github/scripts/release-notes
          uv run python -m release_notes

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          path: artifacts
          merge-multiple: true

      - name: Check gh CLI availability
        run: |
          if ! command -v gh &> /dev/null; then
            echo "::error::GitHub CLI (gh) is not installed. Required for creating releases."
            exit 1
          fi
          echo "✅ GitHub CLI is available: $(gh --version | head -n 1)"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.check-tag.outputs.tag_name }}" \
            --title "Release ${{ needs.check-tag.outputs.tag_name }}" \
            --notes-file release_notes.md \
            --verify-tag \
            artifacts/*
