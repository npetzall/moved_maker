name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"

      - name: Install cargo-llvm-cov (for caching)
        run: cargo install cargo-llvm-cov

      - name: Install cargo-nextest (for caching)
        run: cargo install cargo-nextest

      - name: Install security tools
        run: cargo install cargo-deny cargo-audit cargo-auditable

      - name: Install cargo-geiger
        run: cargo install --locked cargo-geiger

      - name: Run cargo-deny checks (blocking)
        run: cargo deny check --config .config/deny.toml

      - name: Run cargo-audit checks (blocking)
        run: cargo audit --deny warnings

      # Note: cargo-geiger is not blocking - exit code 1 means unsafe code was found (informational)
      # See bugs/01_Quality/done/WORKFLOWS_GEIGER_BLOCKING.md for details
      - name: Run cargo-geiger scan
        run: cargo geiger --output-format Json > geiger-report.json || [ $? -eq 1 ]

      - name: Upload geiger report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        if: always()
        with:
          name: geiger-report
          path: geiger-report.json
          if-no-files-found: warn

  test-ubuntu:
    needs: security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Run tests
        run: cargo nextest run

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5
        with:
          python-version: "3.13"

      - name: Generate test summary
        if: always()
        run: |
          cd .github/scripts/test-summary
          uv run python -m test_summary \
            --xml-path ../../../target/nextest/**/test-results.xml \
            --artifact-name test-results-ubuntu-latest

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        if: always()
        with:
          name: test-results-ubuntu-latest
          path: target/nextest/**/test-results.xml
          if-no-files-found: warn

  test-macos:
    needs: security
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Run tests
        run: cargo nextest run

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5
        with:
          python-version: "3.13"

      - name: Generate test summary
        if: always()
        run: |
          cd .github/scripts/test-summary
          uv run python -m test_summary \
            --xml-path ../../../target/nextest/**/test-results.xml \
            --artifact-name test-results-macos-latest

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        if: always()
        with:
          name: test-results-macos-latest
          path: target/nextest/**/test-results.xml
          if-no-files-found: warn

  coverage:
    needs: test-ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          # Use fetch-depth: 2 to ensure we have the merge commit (HEAD) and its parent (HEAD^1)
          # This allows us to compare HEAD^1 (base branch) with HEAD (merge commit) even when
          # the PR branch has no common ancestor with the base branch
          fetch-depth: 2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate coverage
        run: cargo llvm-cov nextest --all-features

      - name: Check jq availability
        run: |
          if ! command -v jq &> /dev/null; then
            echo "::error::jq is not installed. Required for coverage threshold checking."
            exit 1
          fi
          echo "âœ… jq is available: $(jq --version)"

      - name: Check coverage thresholds
        run: |
          # Generate JSON report from collected coverage data
          cargo llvm-cov report --json > coverage.json

          # Extract percentages and check thresholds using jq script
          jq -r -e -f .config/coverage-threshold-check.jq coverage.json || exit 1

      - name: Detect changed files
        id: changed_files
        run: |
          # Get changed Rust source files in PR for coverage summary
          # HEAD is the merge commit created by GitHub (refs/remotes/pull/N/merge)
          # HEAD^1 is the first parent (base branch), HEAD^2 is the second parent (PR branch tip)
          # Comparing HEAD^1 with HEAD shows all changes introduced by the PR
          # This works even when the PR branch has no common ancestor with the base branch
          CHANGED_FILES=$(git diff --name-only HEAD^1 HEAD | grep '\.rs$' | grep '^src/' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "$CHANGED_FILES" > changed-files.txt
            echo "Changed files detected:"
            echo "$CHANGED_FILES"
          else
            touch changed-files.txt
            echo "No changed Rust source files detected"
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5
        with:
          python-version: "3.13"

      - name: Generate coverage summary
        if: always()
        run: |
          # Generate markdown coverage summary for workflow run summary
          # Summary includes overall coverage, Mermaid chart, and file breakdown
          cd .github/scripts/coverage-summary
          if [ -s "${{ github.workspace }}/changed-files.txt" ]; then
            uv run python -m coverage_summary \
              --json-path "${{ github.workspace }}/coverage.json" \
              --changed-files "${{ github.workspace }}/changed-files.txt" || true
          else
            uv run python -m coverage_summary \
              --json-path "${{ github.workspace }}/coverage.json" || true
          fi

  version:
    needs: coverage
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 0  # Full history needed for version calculation

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5
        with:
          python-version: "3.13"

      - name: Calculate PR version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CARGO_TOML_PATH: ${{ github.workspace }}/Cargo.toml
          VERSION_MODE: pr
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          cd .github/scripts/version
          uv run python -m version

  build-binaries:
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos-aarch64
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true
          cache-on-failure: false

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Rename binary with version
        run: |
          set -euo pipefail
          VERSION="${{ needs.version.outputs.version }}"
          SOURCE="target/${{ matrix.target }}/release/moved_maker"
          DEST="target/${{ matrix.target }}/release/moved_maker-${VERSION}-${{ matrix.platform }}"

          if [ ! -f "${SOURCE}" ]; then
            echo "::error::Source binary not found at ${SOURCE}"
            exit 1
          fi

          mv -v "${SOURCE}" "${DEST}"

          if [ ! -f "${DEST}" ]; then
            echo "::error::Rename failed - destination file not found at ${DEST}"
            exit 1
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@d7d33e16d4ecbbea0da49ecb6fcc16df877ddac8  # v5
        with:
          python-version: "3.13"

      - name: Create checksum
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          cd .github/scripts/create-checksum
          uv run python -m create_checksum \
            --file ${{ github.workspace }}/target/${{ matrix.target }}/release/moved_maker-${VERSION}-${{ matrix.platform }} \
            --algo sha256 \
            --output ${{ github.workspace }}/target/${{ matrix.target }}/release/moved_maker-${VERSION}-${{ matrix.platform }}.sha256

      - name: Upload binary and checksum as artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: moved_maker-${{ needs.version.outputs.version }}-${{ matrix.platform }}
          path: |
            target/${{ matrix.target }}/release/moved_maker-${{ needs.version.outputs.version }}-${{ matrix.platform }}
            target/${{ matrix.target }}/release/moved_maker-${{ needs.version.outputs.version }}-${{ matrix.platform }}.sha256
          retention-days: 7

  pre-commit:
    needs: test-ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.13'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          shared-key: "rust-cache"
          cache-targets: true

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Install pre-commit dependencies
        run: cargo install cargo-nextest cargo-deny cargo-audit

      - name: Run pre-commit
        run: pre-commit run --all-files --fail-fast
