# BUG: Version Workflow Too Complex Using Bash

**Status**: ✅ Complete

## Description

The version calculation workflow in `.github/workflows/release-version.yaml` uses a complex bash script (lines 39-111) that is difficult to maintain, error-prone, and lacks proper error handling. The script performs version calculation, PR label parsing, date comparisons, and version arithmetic using bash string manipulation and command-line tools, which makes it fragile and hard to debug.

## Summary

The current version calculation step uses a 70+ line bash script that:
- Lacks proper error handling for edge cases
- Has no validation of version format or parsed components
- Uses fragile string parsing and arithmetic operations
- Has potential race conditions and token inconsistencies
- Is difficult to test and maintain
- Doesn't handle PR pagination (limited to 100 PRs)

This should be replaced with a Python script that provides:
- Better error handling and validation
- Robust version parsing using `packaging` library
- Proper GitHub API integration using `PyGithub`
- TOML file manipulation using `tomlkit`
- Better maintainability and testability
- Support for PR pagination

## Current State

**Current implementation:** `.github/workflows/release-version.yaml` (lines 39-111)

The workflow uses a complex bash script that:

1. **Fetches tags and calculates base version** (lines 47-60)
   - Uses `git describe` with error suppression
   - Parses version using bash string manipulation
   - No validation of version format

2. **Gets merged PRs since last tag** (lines 65-67)
   - Uses `gh pr list` with `--limit 100` (may miss PRs)
   - No error handling for API failures
   - No pagination support

3. **Parses PR labels** (lines 72-84)
   - Uses `gh pr view` in a loop
   - No error handling if PR is deleted/inaccessible
   - Fragile grep pattern matching

4. **Calculates version** (lines 86-108)
   - Bash arithmetic without validation
   - No check for empty/invalid values
   - Date comparison using jq (potential timezone issues)

5. **Updates Cargo.toml** (lines 113-116)
   - Uses `sed` which may have portability issues
   - No validation of update success

**Issues identified:**

1. **Token inconsistency**: Uses GitHub App token for checkout but `GITHUB_TOKEN` for `gh` CLI (Note: Will use `GITHUB_TOKEN` for script)
2. **Missing error handling**: No validation for version format, empty values, or API failures
3. **PR limit**: Limited to 100 PRs, may miss PRs if more are merged
4. **No validation**: Version components not validated before arithmetic operations
5. **Tag push failure**: If tag push fails, version commit is already pushed (inconsistent state)
6. **Date comparison edge cases**: jq date comparison may have timezone issues
7. **sed portability**: `sed -i` behaves differently on macOS vs Linux

## Expected State

The version calculation should be implemented as a Python script with:

1. **Proper project structure**: Script in its own directory with `pyproject.toml` and `uv.lock`
2. **Robust error handling**: Try/except blocks with clear error messages
3. **Version validation**: Using `packaging` library for version parsing and validation
4. **GitHub API integration**: Using `PyGithub` instead of `gh` CLI for better reliability
5. **TOML manipulation**: Using `tomlkit` to preserve formatting when updating `Cargo.toml`
6. **PR pagination**: Automatic handling of all PRs, not limited to 100
7. **Token usage**: Use `GITHUB_TOKEN` (GitHub Actions token) for script operations
8. **Tag existence checking**: Verify tag doesn't exist before creating
9. **Dependabot integration**: Script dependencies managed via `pyproject.toml` and scanned by Dependabot

**Project structure:**
```
.github/scripts/release-version/
  src/
    release_version/
      __init__.py          # Package initialization
      __main__.py          # Entry point for python -m release_version
      version.py           # Version calculation logic
      github_client.py     # GitHub API client wrapper
      cargo.py             # Cargo.toml manipulation
  tests/
    __init__.py            # Test package initialization
    test_version.py        # Tests for version calculation
    test_github_client.py  # Tests for GitHub client
    test_cargo.py          # Tests for Cargo.toml manipulation
    conftest.py            # Pytest configuration and fixtures
    data/                  # Test data files (for pytest-datadir)
      cargo_toml/
        basic.toml
        with_dependencies.toml
      tags/
        v1.0.0.txt
        v2.3.1.txt
  pyproject.toml           # Project metadata and dependencies
  uv.lock                   # Lock file (generated by uv)
```

**Workflow step:**
```yaml
- name: Install uv
  uses: astral-sh/setup-uv@<commit-sha>

- name: Calculate version from PR labels
  id: version
  env:
    GH_TOKEN: ${{ steps.app-token.outputs.token }}
  run: |
    cd .github/scripts/release-version
    uv run python -m release_version
```

## Impact

### Maintainability Impact
- **Severity**: High
- **Priority**: Medium

Current issues:
- **Complex bash logic**: 70+ lines of bash with nested conditionals and loops
- **Difficult to debug**: Error messages are unclear, no structured logging
- **Hard to test**: Bash scripts are difficult to unit test
- **Fragile parsing**: String manipulation prone to edge case failures
- **No type safety**: Bash variables can be empty or invalid without detection

### Reliability Impact
- **Severity**: Medium
- **Priority**: Medium

Current issues:
- **Missing error handling**: Script may fail silently or produce incorrect versions
- **PR limit**: May miss PRs if more than 100 are merged since last tag
- **Token inconsistency**: Different tokens may have different permissions
- **No validation**: Invalid versions may be calculated and committed
- **Race conditions**: Concurrent pushes could create duplicate tags

### Benefits of Python Implementation
- **Better error handling**: Structured exception handling with clear messages
- **Type safety**: Python's type system catches errors at runtime
- **Testability**: Can write unit tests for version calculation logic
- **Maintainability**: More readable and easier to modify
- **Robust parsing**: Libraries handle edge cases automatically
- **API reliability**: `PyGithub` handles pagination and errors automatically
- **Dependabot support**: Dependencies can be scanned for vulnerabilities

## Affected Files

### Files to Create
- `.github/scripts/release-version/src/release_version/__init__.py`
- `.github/scripts/release-version/src/release_version/__main__.py`
- `.github/scripts/release-version/src/release_version/version.py`
- `.github/scripts/release-version/src/release_version/github_client.py`
- `.github/scripts/release-version/src/release_version/cargo.py`
- `.github/scripts/release-version/tests/__init__.py`
- `.github/scripts/release-version/tests/test_version.py`
- `.github/scripts/release-version/tests/test_github_client.py`
- `.github/scripts/release-version/tests/test_cargo.py`
- `.github/scripts/release-version/tests/conftest.py`
- `.github/scripts/release-version/tests/data/` (test data files)
- `.github/scripts/release-version/pyproject.toml`
- `.github/scripts/release-version/uv.lock` (generated)

### Files to Modify
- `.github/workflows/release-version.yaml` (replace bash script with Python)
- `.github/dependabot.yml` (add pip ecosystem entry)

## Status

✅ **COMPLETED** - Implementation complete. All code has been written, tests are passing (26/26), workflow has been updated, and Dependabot configuration has been added. Ready for testing in a feature branch.

## References

- [uv Documentation](https://docs.astral.sh/uv/)
- [PyGithub Documentation](https://pygithub.readthedocs.io/)
- [packaging Library](https://packaging.pypa.io/)
- [tomlkit Documentation](https://github.com/sdispater/tomlkit)
- [Dependabot Pip Ecosystem](https://docs.github.com/en/code-security/dependabot/dependabot-version-updates/configuration-options-for-the-dependabot.yml-file#pip)
- [GitHub Actions Output](https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#setting-an-output-parameter)

## Notes

- The Python script should be placed in `.github/scripts/release-version/`
- Use `uv` for fast dependency management and environment creation
- `pyproject.toml` is preferred by `uv` and supported by Dependabot
- `uv.lock` ensures reproducible builds
- The script should output to `$GITHUB_OUTPUT` format for workflow integration
- All errors should exit with non-zero status code and clear error messages
- The script should handle first release (no tags) gracefully
- PR pagination is handled automatically by PyGithub
- Token should be `GITHUB_TOKEN` (GitHub Actions token) which is automatically available
- Version validation should use `packaging` library to handle edge cases
- Cargo.toml update should preserve formatting using `tomlkit`


## Related Implementation Plan

See `work/25W46/BUG_VERSION_WORKFLOW_BASH_COMPLEXITY.md` for the detailed implementation plan.
