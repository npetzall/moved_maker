name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0f44b27771c32bda9f458f75a1e241b09791b331  # master
        with:
          toolchain: 1.90.0

      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1

      - name: Install security tools
        run: cargo install cargo-deny cargo-audit cargo-auditable

      - name: Install cargo-geiger
        run: cargo install --locked cargo-geiger

      - name: Run cargo-deny checks (blocking)
        run: cargo deny check --config .config/deny.toml

      - name: Run cargo-audit checks (blocking)
        run: cargo audit --deny warnings

      # Note: cargo-geiger is not blocking - exit code 1 means unsafe code was found (informational)
      # See bugs/01_Quality/done/WORKFLOWS_GEIGER_BLOCKING.md for details
      - name: Run cargo-geiger scan
        run: cargo geiger --output-format Json > geiger-report.json || [ $? -eq 1 ]

      - name: Upload geiger report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: geiger-report
          path: geiger-report.json
          if-no-files-found: warn

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0f44b27771c32bda9f458f75a1e241b09791b331  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt

      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1
        with:
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Run tests
        run: cargo nextest run

      - name: Upload test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: target/nextest/**/test-results.xml
          if-no-files-found: warn

  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0f44b27771c32bda9f458f75a1e241b09791b331  # master
        with:
          toolchain: 1.90.0
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1
        with:
          cache-on-failure: false

      - name: Install cargo-nextest
        run: cargo install cargo-nextest

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate coverage
        run: cargo llvm-cov nextest --all-features

      - name: Check jq availability
        run: |
          if ! command -v jq &> /dev/null; then
            echo "::error::jq is not installed. Required for coverage threshold checking."
            exit 1
          fi
          echo "âœ… jq is available: $(jq --version)"

      - name: Check coverage thresholds
        run: |
          # Generate JSON report from collected coverage data
          cargo llvm-cov report --json > coverage.json

          # Extract percentages and check thresholds using jq script
          jq -r -e -f .config/coverage-threshold-check.jq coverage.json || exit 1

  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0f44b27771c32bda9f458f75a1e241b09791b331  # master
        with:
          toolchain: 1.90.0
          components: clippy rustfmt

      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Install pre-commit dependencies
        run: cargo install cargo-nextest cargo-deny cargo-audit

      - name: Run pre-commit
        run: pre-commit run --all-files --fail-fast
