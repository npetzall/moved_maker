name: Release Version

on:
  push:
    branches:
      - main

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42  # v2.1.4
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Calculate version from PR labels
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # Exit on error - abort workflow if version calculation fails

          # Get latest tag matching v* pattern
          LATEST_TAG=$(git describe --tags --match "v*" --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            # No tag found (first release), use base version from Cargo.toml
            BASE_VERSION=$(grep '^version = ' Cargo.toml | cut -d '"' -f 2)
            if [ -z "$BASE_VERSION" ]; then
              echo "Error: No version found in Cargo.toml and no previous tags exist"
              exit 1
            fi
            VERSION="$BASE_VERSION"
            echo "No previous tag found (first release), using base version from Cargo.toml: $VERSION"
          else
            # Extract version from tag (remove 'v' prefix)
            BASE_VERSION="${LATEST_TAG#v}"

            # Parse version components
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

            # Get merged PRs since last tag
            TAG_DATE=$(git log -1 --format=%ct ${LATEST_TAG})
            PRS=$(gh pr list --state merged --base main --json number,labels,mergedAt --limit 100)

            MAJOR_BUMP=false
            MINOR_BUMP=false

            # Check labels on merged PRs (labels are source of truth, already auto-applied)
            for PR_NUM in $(echo "$PRS" | jq -r '.[] | select(.mergedAt != null) | select((.mergedAt | fromdateiso8601) > '$TAG_DATE') | .number'); do
              LABELS=$(gh pr view $PR_NUM --json labels --jq '.labels[].name' | tr '\n' ' ')

              if echo "$LABELS" | grep -qE "(version: major|breaking)"; then
                MAJOR_BUMP=true
                echo "PR #$PR_NUM has major version label"
              elif echo "$LABELS" | grep -qE "(version: minor|feature)"; then
                MINOR_BUMP=true
                echo "PR #$PR_NUM has minor version label"
              fi
              # No label = patch bump (handled below)
            done

            # Calculate version based on highest bump type found
            if [ "$MAJOR_BUMP" = true ]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              BUMP_TYPE="MAJOR"
            elif [ "$MINOR_BUMP" = true ]; then
              MINOR=$((MINOR + 1))
              PATCH=0
              BUMP_TYPE="MINOR"
            else
              # PATCH bump by commit count
              COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD)
              PATCH=$((PATCH + COMMIT_COUNT))
              BUMP_TYPE="PATCH"
            fi

            VERSION="${MAJOR}.${MINOR}.${PATCH}"

            echo "Latest tag: $LATEST_TAG"
            echo "Bump type: $BUMP_TYPE"
            echo "Calculated version: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT

      - name: Update Cargo.toml version
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ steps.version.outputs.version }}\"/" Cargo.toml
          echo "Updated Cargo.toml version to ${{ steps.version.outputs.version }}"

      - name: Commit and push version update
        run: |
          git add Cargo.toml
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push origin HEAD:main

      - name: Create and push git tag
        run: |
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "Release ${{ steps.version.outputs.tag_name }}"
          git push origin "${{ steps.version.outputs.tag_name }}"
