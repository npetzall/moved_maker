# BUG: Coverage summary script fails to parse JSON - expects array but gets dictionary

**Status**: âœ… Fixed

## Overview
The coverage summary script fails to parse the JSON output from `cargo llvm-cov report --json` because it expects a non-empty array format, but the actual output is a dictionary with a `data` key containing an array.

## Environment
- **OS**: GitHub Actions (ubuntu-latest)
- **Rust Version**: 1.90.0
- **Tool Version**: N/A (script issue)
- **Terraform Version**: N/A

## Steps to Reproduce
1. Run the pull request workflow with coverage job
2. The "Generate coverage summary" step executes
3. The script attempts to parse `coverage.json` generated by `cargo llvm-cov report --json`
4. The parser fails with "Invalid JSON structure: expected non-empty array, got <class 'dict'>"

## Expected Behavior
The coverage summary script should successfully parse the JSON output from `cargo llvm-cov report --json` and generate a markdown summary for the workflow run summary.

## Actual Behavior
The parser raises a `ValueError` because it expects the JSON root to be an array, but `cargo llvm-cov report --json` outputs a dictionary with a `data` key containing the array.

## Error Messages / Output
```
Run # Generate markdown coverage summary for workflow run summary
  # Generate markdown coverage summary for workflow run summary
  # Summary includes overall coverage, Mermaid chart, and file breakdown
  cd .github/scripts/coverage-summary
  if [ -s ../../../changed-files.txt ]; then
    uv run python -m coverage_summary \
      --json-path ../../../coverage.json \
      --changed-files ../../../changed-files.txt || true
  else
    uv run python -m coverage_summary \
      --json-path ../../../coverage.json || true
  fi
  shell: /usr/bin/bash -e {0}
  env:
    CARGO_HOME: /home/runner/.cargo
    CARGO_INCREMENTAL: 0
    CARGO_TERM_COLOR: always
    CACHE_ON_FAILURE: false
    UV_PYTHON_INSTALL_DIR: /home/runner/work/_temp/uv-python-dir
    UV_PYTHON: 3.13
    UV_CACHE_DIR: /home/runner/work/_temp/setup-uv-cache
Downloading cpython-3.13.11-linux-x86_64-gnu (download) (32.7MiB)
 Downloaded cpython-3.13.11-linux-x86_64-gnu (download)
Using CPython 3.13.11
Creating virtual environment at: .venv
   Building coverage-summary @ file:///home/runner/work/moved_maker/moved_maker/.github/scripts/coverage-summary
      Built coverage-summary @ file:///home/runner/work/moved_maker/moved_maker/.github/scripts/coverage-summary
Installed 1 package in 0.75ms
Error parsing coverage JSON: Invalid JSON structure: expected non-empty array, got <class 'dict'>
Traceback (most recent call last):
  File "/home/runner/work/moved_maker/moved_maker/.github/scripts/coverage-summary/src/coverage_summary/__main__.py", line 75, in main
    coverage_data = parse_coverage_json(args.json_path)
  File "/home/runner/work/moved_maker/moved_maker/.github/scripts/coverage-summary/src/coverage_summary/parser.py", line 75, in parse_coverage_json
    raise ValueError(
        f"Invalid JSON structure: expected non-empty array, got {type(data)}"
    )
ValueError: Invalid JSON structure: expected non-empty array, got <class 'dict'>
```

## Minimal Reproduction Case
The issue occurs in `.github/scripts/coverage-summary/src/coverage_summary/parser.py` at line 74-77. The parser validates that the JSON root is an array, but `cargo llvm-cov report --json` outputs a dictionary structure.

**Expected format by parser:**
```json
[
  {
    "totals": {...},
    "files": [...]
  }
]
```

**Actual format from cargo-llvm-cov:**
```json
{
  "data": [
    {
      "totals": {...},
      "files": [...]
    }
  ]
}
```

**Evidence:** The jq script at `.config/coverage-threshold-check.jq` uses `.data[0].totals`, confirming the actual structure has a `data` key.

## Additional Context
- **Affected file**: `.github/scripts/coverage-summary/src/coverage_summary/parser.py` (line 74-77, validation logic)
- **Root cause**: Mismatch between expected JSON structure (direct array) and actual output format (dictionary with `data` key)
- **Impact**: Coverage summary is not generated in workflow run summaries, reducing visibility into coverage changes
- **Frequency**: Always occurs when coverage summary step runs
- **Workaround**: None currently - the step fails silently due to `|| true` in the workflow, but no summary is generated
- **Related code**: The jq script (`.config/coverage-threshold-check.jq`) correctly handles the actual format using `.data[0].totals`

## Related Issues
- Related PRs: N/A
